---
title: "微服务概览与治理"
date: 2020-12-16T10:14:06+08:00
draft: false
tags: ["微服务"]
categories: ["微服务"]
featured_image:
description:
---

## 单体架构

扩展困难，可靠性低。敏捷开发和部署变得困难。应对思路：**化繁为简，分而治之**

## 微服务

### SOA（面向服务的架构模式）是什么？和微服务有什么关联？

* 服务拆分后比较小，BUG 少，容易测试和维护，也容易扩展
* **单一职责**，一个服务只做一件事情
* **尽可能的早的创建原型**，先定义 API，达成契约
* **可移植性比效率更重要**，通讯协议的可移植性更加重要
* 微服务是 SOA 的一种实践，微服务也是面向服务的一种架构

### 微服务是什么

围绕业务功能构建的，服务关注单一业务，服务间采用轻量级的通信机制，可以全自动独立部署，可以使用不同的编程语言和数据存储技术。

### 微服务的好处和不足

#### 好处

* 原子服务，一个服务只做一件事
* 独立进程
* 部署隔离
* 去中心化服务治理
  * 治理去中心化：子服务的更新相互不影响，维持接口协议的稳定即可；
  * 数据去中心化：缓存、业务独立的数据隔离
  * 技术去中心化：减少共享库的依赖

#### 不足

* 基础设施的建设、复杂度高。

  * 开发者必须依靠`RPC`或者`消息传递`来实现进程间通信。
  * 通过代码来解决速度慢或者局部服务不可用的问题

* 分区的数据库架构，同时更新多个业务主体的事务很普遍。

* 测试一个基于微服务架构的应用也是很复杂的任务。

* 服务模块间的依赖，应用的升级有可能会波及多个服务模块的修改。

* 对运维基础设施的挑战比较大。

  

  ## 微服务设计

  

  <img src="/me/image-20201216122535296.png" alt="image-20201216122535296" style="zoom:50%;" />

  
  
  

#### API Geteway  

业务无关的横向功能在这一层处理，例如：路由、认证、限流安全等  



#### BFF（Backend for Frontend）

基于下层微服务做数据组装。BFF 可以认为是一种适配服务，将后端的微服务进行 适配(主要包括聚合裁剪和格式适配等逻辑)，向无线端设备露友好和统一的 API，方便无线设备接入访问后端服务。  



#### 微服务层

具体的服务，本身不对外暴露。采用rpc进行交互。

> **微服务如何拆分？**
>
> * 业务职能
>   * 由公司内部不同部门提供的职能。例如客户服务部门提供客户服务的职能，财务部门提供财务相关的职能。
> * DDD的限界上下文
>   * 限界上下文是 DDD 中用来划分不同业务边界的元素， 这里业务边界的含义是“解决不同业务问题”的问题域 和对应的解决方案域，为了解决某种类型的业务问题， 贴近领域知识，也就是业务。



> **CQRS**
>
> 将应用程序分为两部分:命令端和查询 端。命令端处理程序创建，更新和删除请求，并 在数据更改时发出事件。查询端通过针对一个或 多个物化视图执行查询来处理查询，这些物化视 图通过订阅数据更改时发出的事件流而保持最新 。
>
> ![image-20201216120205602](/me/image-20201216120205602.png)



> **微服务的安全**
>
> * API Gateway: 基于业务Auth鉴权（`jwt token`）
>
> * BFF： 获取上层`jwt token`， 获取`user id`，并注入`context`中（grpc的`metadata`, http的`header`）
>
> * 微服务层：
>
>   ​	在内网主要看安全级别一般有三种：
>
>   - **Full Trust**：假定内网服务之间是安全的，在内网裸奔
>   - **Half Trust**：内网服务之间需要进行认证鉴权，但是不需要所有的都进行加密
>   - **Zero Trust**: 零信任，任务内部网络是不安全的，类似公网，所有的请求通过身份认证鉴权之后，都需要通过安全加密，防止被嗅探
>     - [https://www.microsoft.com/en-us/security/business/zero-trust](https://www.microsoft.com/en-us/security/business/zero-trust)
>
> 
>
> <img src="/me/image-20201216115048304.png" alt="image-20201216115048304" style="zoom:50%;" />

<br>

<center>  ·End·  </center>
